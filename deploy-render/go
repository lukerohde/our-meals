#!/bin/bash

source ./.env-prod

# Check if RENDER_API_KEY is set
if [ -z "$RENDER_API_KEY" ]; then
    echo "Error: RENDER_API_KEY environment variable is not set"
    exit 1
fi

# Set variables
OWNER_ID=$(curl -s \
  -H "Accept: application/json" \
  -H "Authorization: Bearer $RENDER_API_KEY" \
  https://api.render.com/v1/owners | jq -r '.[0].owner.id')

echo "Owner ID: $OWNER_ID"

# # First, create a blueprint
# echo "Creating blueprint..."
# BLUEPRINT_RESPONSE=$(curl -v \
#   -H "Accept: application/json" \
#   -H "Authorization: Bearer $RENDER_API_KEY" \
#   -H "Content-Type: application/json" \
#   -X POST \
#   -d "{
#     \"type\": \"web_service\",
#     \"name\": \"our-meals\",
#     \"ownerId\": \"$OWNER_ID\",
#     \"repo\": \"https://github.com/lukerohde/our-meals.git\"
#   }" \
#   https://api.render.com/v1/blueprints)

# echo "Blueprint Response:"
# echo "$BLUEPRINT_RESPONSE"

# BLUEPRINT_ID=$(echo "$BLUEPRINT_RESPONSE" | jq -r '.id // empty')

# if [ -z "$BLUEPRINT_ID" ] || [ "$BLUEPRINT_ID" = "null" ]; then
#     echo "Error: Failed to create blueprint"
#     exit 1
# fi

# echo "Blueprint created successfully! ID: $BLUEPRINT_ID"

# # Now deploy the blueprint
# echo "Deploying blueprint..."
# DEPLOY_RESPONSE=$(curl -v \
#   -H "Accept: application/json" \
#   -H "Authorization: Bearer $RENDER_API_KEY" \
#   -H "Content-Type: application/json" \
#   -X POST \
#   -d "{
#     \"branch\": \"main\"
#   }" \
#   "https://api.render.com/v1/blueprints/$BLUEPRINT_ID/deploys")

# echo "Deploy Response:"
# echo "$DEPLOY_RESPONSE"

# SERVICE_ID=$(echo "$DEPLOY_RESPONSE" | jq -r '.services[0].id // empty')

# if [ -z "$SERVICE_ID" ] || [ "$SERVICE_ID" = "null" ]; then
#     echo "Error: Failed to deploy blueprint"
#     exit 1
# fi

# echo "Blueprint deployed successfully! Service ID: $SERVICE_ID"

# # Wait for deployment to complete
# echo "Waiting for deployment to complete..."
# while true; do
#     STATUS_RESPONSE=$(curl -s \
#       -H "Accept: application/json" \
#       -H "Authorization: Bearer $RENDER_API_KEY" \
#       https://api.render.com/v1/services/$SERVICE_ID/deploys)
    
#     echo "Status Response:"
#     echo "$STATUS_RESPONSE"
    
#     STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.[0].status // empty')
    
#     echo "Deployment status: $STATUS"
#     if [ "$STATUS" = "live" ]; then
#         break
#     elif [ "$STATUS" = "failed" ]; then
#         echo "Deployment failed!"
#         exit 1
#     elif [ -z "$STATUS" ]; then
#         echo "No deployment status available. Waiting..."
#     fi
#     sleep 30
# done

# echo "Deployment completed successfully!"
